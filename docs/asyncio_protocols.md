# ðŸ—ï¸ Asyncio åè®®ï¼šä¸Šä¸‹æ–‡ç®¡ç†å™¨ä¸Žè¿­ä»£å™¨
# ðŸ—ï¸ Asyncio Protocols: Context Managers and Iterators

å½“ä½ ä½¿ç”¨ `async with` æˆ– `async for` æ—¶ï¼ŒPython éµå¾ªç‰¹å®šçš„åè®®ï¼ˆåº•å±‚è§„åˆ™ï¼‰æ¥ç®¡ç†å¼‚æ­¥ä»£ç çš„è®¾ç½®ã€è¿è¡Œå’Œæ¸…ç†ã€‚

---

## ðŸ§ ä»€ä¹ˆæ˜¯â€œåè®®â€ (What is a Protocol)?

åœ¨ Python çš„ä¸–ç•Œé‡Œï¼Œâ€œåè®®â€ä¸æ˜¯ä¸€ä¸ªæ­»æ¿çš„è¯ä¹¦ï¼ˆæ¯”å¦‚ Java çš„ Interfaceï¼‰ï¼Œè€Œæ˜¯ä¸€åœº**â€œé¢è¯•â€**æˆ–ä¸€æ¬¡**â€œéšå½¢çš„æ‰‹åŠ¿â€**ã€‚

1.  **é¸­å­ç±»åž‹ (Duck Typing)**: 
    â€œå¦‚æžœå®ƒèµ°èµ·è·¯æ¥åƒé¸­å­ï¼Œå«èµ·æ¥ä¹Ÿåƒé¸­å­ï¼Œé‚£å®ƒå°±æ˜¯é¸­å­ã€‚â€ 
    Python ä¸å…³å¿ƒä½ çš„å¯¹è±¡åŽŸæœ¬æ˜¯è°ï¼Œå®ƒåªå…³å¿ƒä½ æ˜¯å¦å®žçŽ°äº†çº¦å®šçš„æ–¹æ³•ï¼ˆæ¯”å¦‚ `__aenter__`ï¼‰ã€‚
    
2.  **è¯­æ³•ä¸Žé€»è¾‘çš„æ¡¥æ¢**:
    å½“ä½ å†™ `async with`ï¼ˆè¯­æ³•ï¼‰æ—¶ï¼ŒPython è§£é‡Šå™¨ä¼šé—®ï¼šâ€œå˜¿ï¼Œè¿™å“¥ä»¬å„¿æœ‰æ²¡æœ‰ `__aenter__` è¿™ä¸ªæ–¹æ³•ï¼ˆåè®®ï¼‰ï¼Ÿâ€å¦‚æžœæœ‰ï¼Œå®ƒå°±æ‰§è¡Œï¼›å¦‚æžœæ²¡æœ‰ï¼Œå®ƒå°±ç½¢å·¥ã€‚
    
3.  **è¡Œä¸ºå¥‘çº¦**:
    åè®®æ˜¯ä¸€ä»½**è¡Œä¸ºå¥‘çº¦**ã€‚ä½ ä¸éœ€è¦æ˜¾å¼åœ°å£°æ˜Žâ€œæˆ‘éµå®ˆåè®®â€ï¼Œåªè¦ä½ å†™äº†è¿™äº› `__` å¼€å¤´çš„æ–¹æ³•ï¼Œä½ å°±è‡ªåŠ¨æˆä¸ºäº†è¯¥åè®®çš„å±¥è¡Œè€…ã€‚

---

## ðŸ—ï¸ `async with` åè®®ï¼šå¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨
## ðŸ—ï¸ The `async with` Protocol: Asynchronous Context Manager

`async with` è¯­å¥ä¸»è¦ç”¨äºŽ **èµ„æºç®¡ç†**ï¼ˆæ‰“å¼€/å…³é—­æ–‡ä»¶ã€èŽ·å–/é‡Šæ”¾é”ï¼Œæˆ–è€…ç®¡ç†åƒ `TaskGroups` è¿™æ ·çš„ç”Ÿå‘½å‘¨æœŸï¼‰ã€‚

### æ ¸å¿ƒæ–¹æ³•ï¼š
1.  **`__aenter__(self)`**:
    - **è§¦å‘æ—¶æœº**: è¿›å…¥ `async with` ä»£ç å—æ—¶ã€‚
    - **èŒè´£**: è®¾ç½®èµ„æºï¼ˆä¾‹å¦‚åˆå§‹åŒ– `TaskGroup`ï¼‰ã€‚å®ƒè¿”å›žçš„å¯¹è±¡å°±æ˜¯ä½ åœ¨ `as` å…³é”®å­—åŽé¢ä½¿ç”¨çš„å¯¹è±¡ã€‚
2.  **`__aexit__(self, exc_type, exc_val, exc_tb)`**:
    - **è§¦å‘æ—¶æœº**: é€€å‡º `async with` ä»£ç å—æ—¶ï¼ˆæ— è®ºæ˜¯æ­£å¸¸é€€å‡ºè¿˜æ˜¯å‘ç”Ÿå¼‚å¸¸ï¼‰ã€‚
    - **èŒè´£**: æ‰§è¡Œæ¸…ç†ã€‚å¯¹äºŽ `TaskGroup`ï¼Œè¿™é‡Œå°±æ˜¯å®ƒç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆå¹¶å¤„ç†å¼‚å¸¸çš„åœ°æ–¹ã€‚

> [!IMPORTANT]
> `async with` **ä¸ä½¿ç”¨** `__iter__` æˆ– `__next__`ã€‚å®ƒä¸¥æ ¼å…³æ³¨â€œè¿›å…¥â€å’Œâ€œé€€å‡ºâ€ä¸€ä¸ªæˆ¿é—´ã€‚

---

## ðŸ”„ `async for` åè®®ï¼šå¼‚æ­¥è¿­ä»£å™¨
## ðŸ”„ The `async for` Protocol: Asynchronous Iterator

`async for` è¯­å¥ç”¨äºŽ **æµå¼æ•°æ®** å¤„ç†ï¼Œæˆ–è€…å½“ä½ å¤„ç†ä¸€ä¸ªåºåˆ—ï¼Œä¸”èŽ·å–â€œä¸‹ä¸€ä¸ªâ€æ¡ç›®å¯èƒ½éœ€è¦ç­‰å¾…ï¼ˆIO é˜»å¡žï¼‰æ—¶ã€‚

### æ ¸å¿ƒæ–¹æ³•ï¼š
1.  **`__aiter__(self)`**:
    - **èŒè´£**: è¿”å›žè¿­ä»£å™¨å¯¹è±¡æœ¬èº«ã€‚
2.  **`__anext__(self)`**:
    - **è§¦å‘æ—¶æœº**: æ¯æ¬¡å¾ªçŽ¯è¯·æ±‚ä¸‹ä¸€ä¸ªæ¡ç›®æ—¶ã€‚
    - **èŒè´£**: è¿”å›žä¸‹ä¸€ä¸ªå€¼ï¼›å¦‚æžœæµå·²ç©ºï¼Œåˆ™æŠ›å‡º `StopAsyncIteration`ã€‚

---

## ðŸŽ¬ éšå–»ï¼šVIP åŒ…åŽ¢ vs. ä¼ è¾“å¸¦
## ðŸŽ¬ Metaphor: The VIP Room vs. The Conveyor Belt

| åè®® | éšå–» | åŠ¨ä½œæè¿° |
| :--- | :--- | :--- |
| **`async with`** | **VIP åŒ…åŽ¢ (The VIP Room)** | ä½ è¿›å…¥åŒ…åŽ¢ (`__aenter__`)ï¼Œåœ¨é‡Œé¢å·¥ä½œï¼Œæœ€åŽåœ¨ç¦»å¼€å‰ç»“è´¦/æ¸…ç† (`__aexit__`)ã€‚ |
| **`async for`** | **ä¼ è¾“å¸¦ (The Conveyor Belt)** | ä½ ç«™åœ¨åŽŸåœ°ï¼Œä¸æ–­æŠ“å–ä¼ è¿‡æ¥çš„ä¸‹ä¸€ä¸ªç‰©å“ (`__anext__`)ï¼Œç›´åˆ°å¸¦å­ç©ºäº†ã€‚ |

---

## ðŸ’» æ€»ç»“è¡¨ / Summary Table

| è¯­å¥ | åè®®ç±»åž‹ | å…³é”®æ–¹æ³• |
| :--- | :--- | :--- |
| `async with` | å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨ | `__aenter__`, `__aexit__` |
| `async for` | å¼‚æ­¥è¿­ä»£å™¨ | `__aiter__`, `__anext__` |

---

## ðŸ” æ·±åº¦æ‹†è§£ï¼š`TaskGroup` çš„å†…éƒ¨å®žçŽ°

ä¸ºäº†å›žç­”ä½ çš„æ·±åº¦é—®é¢˜ï¼Œæˆ‘ä»¬ç›´æŽ¥çœ‹ `asyncio/taskgroups.py` çš„â€œå¿ƒç”µå›¾â€ï¼š

- **çŠ¶æ€æ¿€æ´»ä¸Žåˆå§‹åŒ– (`__aenter__`)**: ä½ çš„æ€»ç»“éžå¸¸ç²¾å‡†ï¼Œè¿™ç¡®å®žæ˜¯ä¸€ä¸ªâ€œå…­æ­¥èµ°â€çš„ä¸¥å¯†è¿‡ç¨‹ï¼š
  1. **é˜²é‡å…¥æ£€æŸ¥**ï¼šç¡®è®¤ä¸æ˜¯ç¬¬äºŒæ¬¡è¿›é—¨ã€‚
  2. **é”å®šç‰‡åœº (Loop)**ï¼šæ‹¿åˆ°å½“å‰è¿è¡Œçš„ `Event Loop` å¯¹è±¡ã€‚
  3. **è®¤äº² (Parent Task)**ï¼šæ•æ‰å½“å‰æ­£åœ¨è¿è¡Œçš„é‚£ä¸ª `Task` ä½œä¸ºçˆ¶äº²ã€‚
  4. **åˆè§„æ€§æ£€æŸ¥**ï¼šå¦‚æžœæ‰¾ä¸åˆ°çˆ¶ä»»åŠ¡ï¼ˆä¸åœ¨åç¨‹é‡Œï¼‰ï¼Œç›´æŽ¥æŠ¥é”™ã€‚
  5. **æ¿€æ´»å¼€å…³**ï¼šå°† `_entered` è®¾ä¸º `True`ã€‚
  6. **è‡ªæˆ‘äº¤ä»˜**ï¼š`return self`ã€‚

#### ðŸ“‹ `__aenter__` è½åœ°å¤ç›˜è¡¨

| æ­¥éª¤ | æºç è¡Œä¸º | æ ¸å¿ƒè§†è§’ | ç»“è®º |
| :--- | :--- | :--- | :--- |
| **1** | `if self._entered` | æ£€æŸ¥æ˜¯å¦ç¬¬ä¸€æ¬¡å©é—¨ | **é˜²é‡å…¥**ï¼šä¸¥ç¦åµŒå¥—ä½¿ç”¨åŒä¸€ä¸ªå®žä¾‹ |
| **2** | `get_running_loop()` | æ‹¿åˆ° Loop åœ°å€ | **é”å®šç‰‡åœº**ï¼šç¡®å®šæ•ˆå¿ çš„å¯¼æ¼” |
| **3** | `current_task()` | ç¡®è®¤ parent çº§ | **è®¤é¢†ç›‘æŠ¤äºº**ï¼šç¡®å®šçˆ¶å­è¡€ç¼˜è”ç³» |
| **4** | `if ... is None` | æ£€æŸ¥ç›‘æŠ¤äººçŠ¶æ€ | **åˆè§„æ£€æŸ¥**ï¼šç¡®ä¿è¿è¡Œåœ¨ Task çŽ¯å¢ƒä¸­ |
| **5** | `_entered = True` | çŠ¶æ€æ¿€æ´» | **åˆé—¸é€šç”µ**ï¼šæ­£å¼å¼€å§‹è¥ä¸š |
| **6** | `return self` | äº¤ä»˜è‡ªå·± | **åç‰‡é€’äº¤**ï¼šè®© `as tg` æ‹¿åˆ°æŽ§åˆ¶æƒ |

---
### 3. é‚£äº›è®©ä½ å›°æƒ‘çš„ä»£ç è¡Œæ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ

- **`if self._entered: raise RuntimeError(...)` (ç¬¬ 56-58 è¡Œ)**:
  è¿™æ˜¯ä¸ºäº†é˜²æ­¢**é‡å¤è¿›å…¥**ã€‚`TaskGroup` æ˜¯â€œä¸€æ¬¡æ€§â€çš„ï¼ˆæˆ–è€…è¯´ä¸¥ç¦åµŒå¥—ä½¿ç”¨åŒä¸€ä¸ªå®žä¾‹ï¼‰ã€‚å¦‚æžœä½ å†™äº† `async with tg: async with tg:`ï¼Œç¬¬äºŒæ¬¡è¿›é—¨æ—¶ `_entered` å·²ç»æ˜¯ `True` äº†ï¼Œç³»ç»Ÿä¼šç«‹åˆ»æŠ¥è­¦ã€‚è¿™æ˜¯ä¸ºäº†ä¿è¯æ¯ä¸€ä¸ª `TaskGroup` å®žä¾‹åªè´Ÿè´£è‡ªå·±çš„é‚£ä¸€æ®µç”Ÿå‘½å‘¨æœŸï¼Œé˜²æ­¢é€»è¾‘æ··ä¹±ã€‚

- **`if self._loop is None: self._loop = events.get_running_loop()` (ç¬¬ 59-60 è¡Œ)**:
  è¿™æ˜¯åœ¨**é”å®šç‰‡åœº**ã€‚å®ƒè¦æ˜Žç¡®çŸ¥é“è‡ªå·±å½“å‰æ˜¯åœ¨å“ªä¸ªâ€œäº‹ä»¶å¾ªçŽ¯â€é‡Œè¿è¡Œã€‚è¿™ç¡®ä¿äº†å®ƒåŽé¢åˆ›å»ºçš„æ‰€æœ‰å­ä»»åŠ¡ã€ä»¥åŠå®ƒè¦è®¤çš„â€œçˆ¶äº²â€ï¼ˆçˆ¶ä»»åŠ¡ï¼‰ï¼Œéƒ½å¤„åœ¨åŒä¸€ä¸ªæ—¶ç©ºç»´åº¦é‡Œã€‚

### 2. æœ‰æ²¡æœ‰ Future çŠ¶æ€æœºï¼Ÿ
**æœ‰ï¼Œè€Œä¸”æ˜¯æ ¸å¿ƒï¼**
åœ¨ `TaskGroup` å†…éƒ¨ï¼Œæœ‰ä¸€ä¸ªéšè—çš„ç§˜å¯†æ­¦å™¨ï¼š`self._on_completed_fut`ã€‚
- è¿™æ˜¯ä¸€ä¸ªçœŸæ­£çš„ `asyncio.Future` å¯¹è±¡ã€‚
- **å®ƒçš„é€»è¾‘æ˜¯**ï¼šåªæœ‰å½“ `self._tasks`ï¼ˆä»»åŠ¡é›†åˆï¼‰å˜ä¸ºç©ºæ—¶ï¼Œè¿™ä¸ª Future æ‰ä¼š `set_result(True)`ã€‚
- **åœ¨å“ªé‡Œç”¨ï¼Ÿ** åœ¨ `__aexit__` åè®®é‡Œã€‚å½“ä½ å‡†å¤‡ç¦»åœºæ—¶ï¼Œ`__aexit__` ä¼š `await self._on_completed_fut`ã€‚è¿™æ­£æ˜¯ä¸ºä»€ä¹ˆ `async with` ä¼šâ€œå¡â€åœ¨å‡ºå£ï¼Œç›´åˆ°æ‰€æœ‰ä»»åŠ¡å®Œæˆçš„çœŸæ­£åŽŸå› ã€‚

---

> â€œè¯­æ³•æ˜¯å‰§æœ¬çš„æ¡†æž¶ï¼Œè€Œåè®®æ˜¯æ¼”å‘˜ï¼ˆå¯¹è±¡ï¼‰å¯¹æ¡†æž¶çš„ç²¾å‡†å¡«å……ã€‚â€
> "Syntax is the frame of the script; Protocols are the object's precise fulfillment of that frame."
